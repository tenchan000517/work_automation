# 業務効率化・マニュアル作成プロジェクト HANDOFF

## プロジェクト概要

制作陣の業務効率化とマニュアル整備プロジェクト。
9商材・52業務を対象に、AI活用による効率化とマニュアル改善を推進。

**ガイドライン**:
- `docs/manual-creation-guideline-v2.md` ★最新版（GASダイアログ設計指針）
- `docs/manual-creation-guideline.md` 旧版（データ構造・型定義の参照用）

---

## 設計思想

### スプレッドシート中心の設計
本体はスプレッドシート+GAS。Next.jsサイトは補助（閲覧用ビュー）。

**理由**: 担当者が直接メンテナンスできる。コード変更不要。

### GASの2つの機能
- **AIプロンプト生成**: データ+プロンプト → AIに貼り付け → AI出力を使う
- **フォーマット生成**: データ+テンプレート → そのまま使える定型文

### 基本セット構成
- プロンプトシート（AIプロンプト管理）
- 設定シート（担当者名等の設定値）
- フォーム連携時: 回答シート + 原本シート

**理由**: この構成なら新商材追加時も同じパターンで対応可能。

### GASダイアログとNext.js popupのUI統一
GASダイアログとNext.jsのオレンジボタン（popup）は同じ機能・同じUIにする。

**理由**:
- 開発時に片方を見れば両方わかる
- 設計が統一され、保守が楽
- ユーザー体験が一貫する

**UI仕様**: ガイドラインの「ダイアログUI仕様」を参照

### 入力データの永続化
ダイアログで入力したデータは一時的ではなく、スプレッドシートに保存して再利用する。

**フロー:**
1. 貼り付け → 対象シートのセルに保存
2. 次回開く → セルから読み込み → フィールドに自動入力
3. 後続フローでも同じデータを参照可能

**上書き時の挙動:**
- 既にデータがある状態で新規入力 → 「上書きしますか？」アラート
- OK → 上書き保存

**除外シート（対象シート選択肢に出さない）:**
- プロンプト
- 設定
- フォームの回答1
- ヒアリングシート（原本/テンプレート）

これらはシステムシートなので、企業データ保存先として選択不可。

---

## 商材別業務一覧

| 商材 | 業務数 | 進捗 |
|------|--------|------|
| ツナゲル | 14 | 配列順0〜5を新形式に移行済み |
| バツグン | 5 | 基本情報のみ |
| HP制作 | 8 | 基本情報のみ |
| LP制作 | 5 | 基本情報のみ |
| SNS広告 | 5 | 基本情報のみ |
| PV制作 | 5 | 基本情報のみ |
| パンフ | 3 | 基本情報のみ |
| ロゴ | 3 | 基本情報のみ |
| 月刊Sing | 4 | 基本情報のみ |
| **合計** | **52** | - |

---

## 完了済み機能

### システム基盤
- Next.js 16 + TypeScript + Tailwind CSS v4
- 商材別データ分割管理（`src/lib/data/*.ts`）
- 担当者別色分け表示
- 複数入力フィールド対応（InputFieldConfig）

### ツナゲル業務フロー
- 配列順0〜5: flowSteps + 複数入力フィールド対応
- GAS連携: ヒアリングシート管理、構成案生成、撮影フォルダ作成

### GASスクリプト
- `commonStyles.js`: ★共通スタイル定義（CI_DIALOG_STYLES, CI_UI_COMPONENTS）
- `settingsSheet.js`: 設定シート管理（単独ファイル）
- `hearingSheetManager.js`: ヒアリングシート統合管理（onOpen含む）
- `companyInfoManager.js`: キックオフ・企業情報入力
- `transcriptToHearingSheet.js`: 文字起こし転記
- `compositionDraftGenerator.js`: 構成案作成
- `createShootingFolder.js`: 撮影フォルダ作成
- `contactFormats.js`: 連絡用フォーマット
- `promptDialog.js`: 議事録作成・報告プロンプト

---

## ファイル構成

```
C:\work-manual\
├── HANDOFF.md                      # このファイル
├── docs/
│   ├── manual-creation-guideline.md  # マニュアル作成ガイドライン ★重要
│   ├── gas/                        # GASスクリプト（商材別フォルダ）
│   │   ├── tsunageru/              # ツナゲル専用
│   │   │   ├── commonStyles.js          # ★共通スタイル定義
│   │   │   ├── settingsSheet.js         # 0.設定シート管理
│   │   │   ├── hearingSheetManager.js   # メイン（onOpen含む）2.ヒアリング・フォルダ
│   │   │   ├── companyInfoManager.js    # 1.キックオフ・企業情報入力
│   │   │   ├── promptDialog.js          # 4.議事録作成・報告プロンプト
│   │   │   ├── compositionDraftGenerator.js # 5.構成案作成
│   │   │   ├── contactFormats.js        # 連絡用フォーマット
│   │   │   ├── transcriptToHearingSheet.js  # 文字起こし転記（4に統合）
│   │   │   ├── createShootingFolder.js  # 撮影フォルダ作成（2に統合）
│   │   │   ├── sheetStructureChecker.js # メンテナンス用
│   │   │   └── _archive/           # 旧バージョン・未使用ファイル
│   │   └── (他商材)/               # 追加時にフォルダ作成
│   ├── prompts/                    # AIプロンプト
│   └── 業務一覧/                   # 商材別業務詳細（txt）
│
├── src/
│   ├── app/                        # Next.js Pages
│   ├── components/
│   │   ├── ContentModal.tsx        # ポップアップモーダル
│   │   └── TaskCard.tsx            # 業務カード
│   └── lib/
│       ├── data.ts                 # 再エクスポート
│       └── data/                   # 商材別データ
│           ├── index.ts            # 型定義
│           ├── tsunageru.ts        # ツナゲル（モデル）
│           └── ...                 # 他8商材
│
└── public/images/                  # スクリーンショット
```

---

## 開発コマンド

```bash
npx tsc --noEmit    # TypeScriptエラーチェック（コード変更後は必ず実行）
```

---

## 新形式とは

ツナゲルで確立した業務カードの形式。詳細は `docs/manual-creation-guideline.md` 参照。

**要点:**
- `flowSteps`: 業務の手順を横並びボックスで表示
- `inputFields`: 複数入力フィールド（企業名、日時、宛先等を個別入力）
- 画像は必ずキャプション付き（`{ url, caption }`形式）
- 担当者名はハードコードせず、`defaultValue`で設定

---

## 本セッションの進捗（2026-01-12）

### ✅ 完了: GASメニュー表示問題の修正

**真の原因:** GASエディタの「シート分析.gs」に`CI_DIALOG_STYLES`が重複定義されていた

**解決:** シート分析.gsを削除

**追加で修正したコード問題:**

| # | 問題 | 修正内容 |
|---|------|----------|
| 1 | `COMPANY_LIST_SHEET_NAME_EDIT` 未定義 | `COMPANY_LIST_SHEET_NAME` に統一 |
| 2 | `getFormUrlFromSettings()` 重複定義 | companyInfoManager.jsから削除 |
| 3 | `getCompanyInfoFromSheet()` 未定義 | 新規実装（移行機能用） |

---

### ✅ 完了: 企業情報取得の修正

**問題:** 企業名がA列固定で取得されていた（実際はB列）

**修正:**
- `getCompanyListFromSheet()` - ヘッダーから「企業名」列を動的検索するように変更

---

### ✅ 完了: 企業選択時の担当者自動入力

**問題:**
- 制作担当（メイン担当/サブ担当）がヒントに表示されていた
- 企業の担当者名（連絡先）が入力されていなかった

**修正:**
- `getCompanyAssigneesFromList()` - `contactName`（企業の担当者名）を追加取得
- `loadCompanyAssignees()` - 企業選択時に担当者名フィールドへ自動入力
- 不要な制作担当ヒント表示を削除

**動作:** 企業選択 → 企業情報一覧の「担当者名」列を取得 → 担当者名フィールドに自動入力

---

## 本セッションの進捗（2026-01-12 続き②）

### ✅ 完了: hearingSheetManager.jsのフォーム回答選択UIをドロップダウン形式に変更

**問題:** 旧式の`<select size="10">`を使用していた

**修正:**
- ドロップダウン形式に変更（クリックで展開/閉じる）
- **アクティブバッジ（緑）**: 現在開いているシートに対応するフォーム回答に表示
- **ソート順**: アクティブが最上段、残りは新しい順（スプレッドシートの下の行が上）
- アクティブがあれば自動選択
- ドロップダウン外クリックで閉じる

---

### ✅ 完了: 共通スタイル（commonStyles.js）を全GASに適用

**適用済みファイル（計7ファイル）:**
| ファイル | 修正内容 |
|----------|----------|
| companyInfoManager.js | ✅ 前回対応済み |
| promptDialog.js | ✅ `${CI_DIALOG_STYLES}` + 固有スタイル + `${CI_UI_COMPONENTS}` |
| compositionDraftGenerator.js | ✅ `${CI_DIALOG_STYLES}` + 固有スタイル（script部は維持※1） |
| contactFormats.js | ✅ `${CI_DIALOG_STYLES}${CONTACT_FORMATS_STYLES}` に置換 |
| transcriptToHearingSheet.js | ✅ `${CI_DIALOG_STYLES}` + 固有スタイル（2ダイアログ） |
| createShootingFolder.js | ✅ `${CI_DIALOG_STYLES}` + 固有スタイル（3ダイアログ） |
| hearingSheetManager.js | ✅ `${CI_DIALOG_STYLES}` + 固有スタイル |

**※1 compositionDraftGeneratorの注意点:**
- `toggleAccordion`が`show`クラス＋独自実装（共通版は`open`クラス）
- `showStatus`が固有の動作
- script部分は変更せず、スタイル部分のみ共通化

**適用方針（安全に進めた結果）:**
1. 各ファイルの独自`<style>`を`${CI_DIALOG_STYLES}`に置換
2. 共通スタイルで既にカバーされているスタイルは削除
3. 固有のスタイル（各ファイル特有のUIパーツ）は残す
4. script部分は基本的に維持（動作の違いによる不具合を避けるため）
5. `${CI_UI_COMPONENTS}`は、共通関数（copyToClipboard, toggleAccordion）と競合しない場合のみ追加

---

## 将来の改善（全フロー確定後）

### 「各種フォーマット」シートの作成・実装

メールテンプレートなどのフォーマットを「各種フォーマット」シートから取得するように改善する。

**方針:**
- 「プロンプト」シートとほぼ同様のロジック
- シートにフォーマット名、テンプレート内容などを保存
- ダイアログからシートのフォーマットを読み込んで使用

**実装タスク:**
1. 設定メニュー（`addSettingsMenu`）に以下を追加:
   - 「📋 各種フォーマットシートを作成」
   - 「📝 各種フォーマット編集」
2. `initializeFormatSheet()` - 各種フォーマットシート作成関数
3. `showFormatEditDialog()` - 各種フォーマット編集ダイアログ
4. `getFormatFromSheet(formatName)` - フォーマット取得関数

**将来的な拡張:**
- ダイアログとフォーマットの紐づけも各種フォーマットシートで管理
- 例: 「日程調整メール」ダイアログ → 「日程調整テンプレート」フォーマット

**参考:** `settingsSheet.js` の `initializePromptSheet()`, `showPromptEditDialog()`

---

## 過去の引き継ぎ（2026-01-11 完了済み）

### ✅ 完了: 企業選択UIを確定

カスタムドロップダウン形式で確定。

**仕様:**
- ラジオボタンで「一覧から選択 / 手入力」切り替え
- チェックボックス表示（選択状態が明確）
- ハイライト（選択中は青背景）
- アクティブバッジ（現在開いているシートの企業に緑バッジ）
- ソート: アクティブ最上段 → 新しい順（スプレッドシート下の行が上）
- システムシート（プロンプト、設定等）を開いている場合はアクティブなし

**実装ファイル:** `companyInfoManager.js` の `showOrderReportDialog()`, `createOrderReportHTML()`

### ✅ 完了: スタイルHTMLファイルを作成

共通スタイル・コンポーネントをHTMLファイルとして分離。

**作成ファイル:**
```
docs/gas/tsunageru/
├── dialogStyles.html    # 共通CSS
└── uiComponents.html    # 共通JavaScript（ドロップダウン等）
```

### ✅ 解決: uiComponents.htmlのスクリプト動作問題

**原因:**
- GASの `HtmlService.createHtmlOutputFromFile().getContent()` が `<script>` タグをサニタイズしていた
- `<style>` タグ（CSS）は通過するが、`<script>` タグ（JS）は異なる処理を受ける

**解決方法:**
- HTMLファイル分離をやめ、JS定数として `commonStyles.js` に分離
- `CI_DIALOG_STYLES` と `CI_UI_COMPONENTS` 定数を `commonStyles.js` で定義
- 各GASファイルから参照（GASは同じプロジェクト内でグローバルスコープ共有）

**ファイル構成:**
```
docs/gas/tsunageru/
├── commonStyles.js        ← ★共通スタイル定義（新規）
├── companyInfoManager.js  ← 共通スタイルを参照
├── settingsSheet.js       ← 共通スタイルを参照可能
├── promptDialog.js        ← 共通スタイルを参照可能
└── ...
```

**使い方:**
```javascript
// commonStyles.js で定義済みの定数を直接使用
return `
<!DOCTYPE html>
<html>
<head>${CI_DIALOG_STYLES}</head>
<body>
  ...
  ${CI_UI_COMPONENTS}
</body>
</html>
`;
```

**他商材への展開:**
- `commonStyles.js` + 各機能GASファイルをコピペ
- GASエディタで同じプロジェクトに追加すれば動作

---

## 本セッションの進捗（2026-01-11 続き⑤）

### ✅ 完了: 企業情報入力ダイアログのバグ修正

**問題点:**
1. パースが■列をスキップしていないのでデータがズレる
2. placeholderテキストが不適切
3. 受注・キックオフ連絡に内部メッセージが表示されている

**修正内容:**

#### 1. ■列スキップ対応（3関数を修正）

| 関数 | 修正内容 |
|------|----------|
| `addCompanyInfoToList()` | ヘッダーを動的に読み取り、■列は空文字で保存 |
| `getCompanyInfoFromList()` | ヘッダーを動的に読み取り、■列をスキップして読み取り |
| `updateCompanyInfoInList()` | ヘッダーを動的に読み取り、■列をスキップして更新 |

**修正方法:**
- ハードコードされた12列配列 → ヘッダー動的読み取り+フィールドマッピング
- `h.startsWith('■')` で判定してスキップ

#### 2. placeholderテキスト変更

```
変更前: 上のテンプレートをコピーして記入後、貼り付けてください
変更後: テンプレート通りに記入済みの企業情報を貼り付けてください
        例：営業担当からワークスで送られてきた情報
```

#### 3. 内部メッセージ削除

受注・キックオフ連絡ダイアログから「企業情報一覧から取得（アクティブ優先・新しい順）」のヒントを削除。

**ファイル:** `companyInfoManager.js`

**GASエディタへの反映:** `companyInfoManager.js` をGASエディタにコピペして上書き

---

## 本セッションの進捗（2026-01-11 続き④）

### ✅ 完了: 設定シートに企業情報項目セクションを追加

**目的:** 企業情報一覧シートの項目（ヘッダー）を設定シートで管理

**実装内容:**
1. `DEFAULT_COMPANY_INFO_HEADERS`定数追加（71-88行）
2. `initializeSettingsSheet()`にK列「企業情報項目」セクション追加
3. `getCompanyInfoHeadersFromSettings()`関数追加（設定シートから読み取り）
4. `initializeCompanyListSheet()`を設定シートから動的に読み取るよう修正
5. ■セクション列のデータエリアをグレーアウト（入力不要を明示）

**設定シート構造（更新後）:**
```
A列〜B列: メンバー一覧
D列〜F列: 業務担当者
H列〜I列: フォルダ設定
K列: 企業情報項目 ★新規
  ├── ■基本情報（セクション区切り・紫背景）
  ├── 企業名
  ├── 担当者名
  ├── ...
  ├── ■受注内容
  ├── ...
  └── ■制作担当
```

**フロー:**
1. 設定シート作成 → K列にデフォルト項目が入る
2. 企業情報一覧を作成 → 設定シートK列から読み取ってヘッダー作成
3. 項目変更 → 企業情報一覧シートのヘッダーを直接編集
4. テンプレート生成 → 企業情報一覧シートから読み取り

**ファイル:** `settingsSheet.js`

---

## 本セッションの進捗（2026-01-11 続き③）

### ✅ 完了: 企業情報入力ダイアログにテンプレート表示機能を追加

**実装内容:**
1. `getCompanyInfoTemplate()` 関数を追加（52-106行）
2. 企業情報一覧シートのヘッダーから動的にテンプレート生成
3. 「■」で始まる列をセクション区切りとして認識
4. アコーディオン形式でダイアログ最上段に表示
5. コピーボタンで即座にテンプレートをコピー可能

**テンプレート生成例:**
```
企業情報一覧シートのヘッダー:
| ■基本情報 | 企業名 | 担当者名 | ... | ■受注内容 | 受注商材 | ... |

生成されるテンプレート:
============================
■基本情報
============================
企業名:
担当者名:
...

============================
■受注内容
============================
受注商材: ツナゲル
...
```

**デフォルト値:** `受注商材: ツナゲル`（自動入力）

### ✅ 完了: 文言修正

| 変更前 | 変更後 |
|--------|--------|
| Works | ワークス |
| パース | 展開 |

**変更箇所:** メニュー名、ダイアログタイトル、ラベル、ボタン、メッセージ

### ✅ 完了: UIをガイドライン準拠に修正

- クラス名: `accordion`に統一
- ボタン色: `btn-blue`（青）
- ラベル: 「企業情報テンプレートを表示」
- レイアウト: テンプレートを最上段に配置
- `CI_DIALOG_STYLES`に`btn-blue`を追加

---

## 本セッションの進捗（2026-01-11 続き②）

### ✅ 完了: 受注・キックオフ連絡ダイアログのUI修正

**参考UI:** `promptDialog.js` の `getPromptDialogHtml()`

**修正内容:**
1. アコーディオン: グレー背景 → 白背景+枠線（カード形式）
2. 「テンプレートを表示」+ コピーボタンをタイトル行右端
3. 入力セクション: カード形式
4. 「出力」→「プレビュー」+ 緑コピーボタン
5. 閉じるボタン: 右下に単独配置
6. フォントサイズ: body指定削除（16px）、各要素も調整
7. 絵文字削減、ボタン表記「コピー」に統一
8. コピー成功: 上部トースト表示
9. 宛先・CCを横並び
10. 生成ボタン削除、企業選択で自動プレビュー
11. テンプレート文言を新形式に変更

**テンプレート:**
```
今後の連絡はこちらのグループで行います。

@{{宛先}} cc:@{{CC}}
新規受注です。
{{企業名}}様、ツナゲル12ヶ月契約。
初回打ち合わせは調整中です。
日程が決まり次第企業詳細と共にご連絡します！
```

### ✅ 完了: ダイアログサイズ統一

- 横幅: **700px**（統一・固定）
- 高さ: **750px**（基本値、完全固定ではない）

### ✅ 完了: ガイドラインV2更新

確定UIを反映:
- 3.1 ダイアログサイズ
- 3.3 担当者選択コンポーネント【確定】
- 3.4 企業選択コンポーネント（未確定）
- 3.5 テンプレート表示【確定】
- 3.6 プレビューセクション【確定】
- 3.7 コピーボタンの表示/非表示【確定】

---

## 確定UI一覧

| 項目 | 仕様 | 状態 |
|------|------|------|
| ダイアログ横幅 | 700px | 確定（統一） |
| ダイアログ高さ | 750px | 確定（基本値） |
| 担当者選択 | コンパクトドロップダウン | 確定 |
| テンプレート表示 | 白背景+枠線、コピーボタンはタイトル行右端 | 確定 |
| プレビューUI | カード形式、緑コピーボタン | 確定 |
| コピーボタン | プレビュー生成後に表示（display制御） | 確定 |
| 企業選択UI | カスタムドロップダウン（チェック・ハイライト・アクティブバッジ） | 確定 |
| 貼り付けUI | 入力用（永続化）・出力用（readonly）、動的ラベル対応 | 確定 |

---

## 本セッションの進捗（2026-01-11 続き）

### ✅ 完了: 受注・キックオフ連絡ダイアログの改善（途中）

**実装済み:**
1. 企業名ドロップダウン（企業情報一覧から新しい順）
2. コンパクトドロップダウン（担当者選択UI）
3. テンプレートアコーディオン（上部に配置）
4. コピーボタンの遅延表示（生成後に表示）

### ✅ 完了: ガイドラインV2作成

`docs/manual-creation-guideline-v2.md` を新規作成。
- GASダイアログ設計の最新指針
- コンパクトドロップダウンUI仕様
- テンプレートアコーディオンUI仕様

### ✅ 完了: 将来タスクの記録

GAS UIコンポーネントの共通化（HTMLファイル分離）を将来タスクとして記録。

---

## 本セッションの進捗（2026-01-11）

### ✅ 完了: GASメニュー構成の大幅変更

**新メニュー構成:**
```
０.⚙️ 設定
├── 👥 メンバー編集
├── 📝 業務担当者編集
├── 📁 フォルダ設定編集
├── ─────────────
├── 📄 プロンプト編集
├── ─────────────
├── 📋 設定シートを作成
├── 📝 プロンプトシートを作成
└── 📊 企業情報一覧を作成

１.📋 キックオフ・企業情報入力 ★新規
├── 📥 企業情報入力（ワークス貼り付け）
├── 📢 受注・キックオフ連絡
├── 📩 先方へ日程調整・フォーム記入依頼メール
├── ─────────────
├── 🏢 企業情報編集
├── ─────────────
└── 📊 企業情報一覧反映

２.📋 ヒアリングシート・撮影フォルダ ★統合
├── 🆕 新規ヒアリングシート作成（フォーム回答から）
├── 🆕 新規ヒアリングシート作成（手動）
├── ─────────────
├── 📂 新規フォルダ作成（企業シートから）
├── 🆕 新規フォルダ作成（手動）
├── ─────────────
├── 📥 フォーム回答を既存シートに転記
├── ─────────────
├── 📋 最近作成した企業フォルダ一覧
├── ─────────────
├── 🎨 テンプレート初期設定
└── ⚙️ 親フォルダを設定

４.📝 議事録作成・報告プロンプト ★文字起こし統合
├── （プロンプトシートから動的生成）
├── ─────────────
├── 📋 文字起こしを整理（プロンプト生成）
├── 📥 AI出力を転記
├── ─────────────
├── 📄 プロンプトシートを作成
├── 🔄 サンプルプロンプトを追加
└── ❓ 使い方

５.📝 構成案作成
├── 📋 構成案を作成（プロンプト生成）
├── ─────────────
├── 📤 ペアソナ/エンゲージ形式に変換
├── 📤 ワークス報告用に変換
├── 📤 撮影指示書に変換
├── ─────────────
└── 🔧 シートデータ確認

📨 連絡用フォーマット ★ナンバリングなし
├── 📋 日程確定報告
├── ─────────────
├── 📷 撮影日程確認
├── 🔔 参加者リマインド
├── ─────────────
├── 🎬 撮影指示連絡
└── 📝 議事録共有
```

### ✅ 完了: 企業情報機能を企業情報一覧シート中心に修正

**1. 企業情報編集（🏢）**
- 旧: 個別企業シート（株式会社○○シート）から直接読み書き
- 新: 企業情報一覧シートから読み書き

**2. 企業情報入力（📥 Works貼り付け）**
- 旧: 個別企業シートに保存 or 新規シート作成
- 新: 企業情報一覧シートに新規行追加

**3. 定数の整理**
- `COMPANY_LIST_SHEET_NAME_EDIT` をファイル先頭に移動
- 重複定義（`COMPANY_LIST_SHEET_NAME_CI`）を統一

**新しい関数:**
| 関数名 | 役割 |
|--------|------|
| `getCompanyListFromSheet()` | 企業情報一覧から企業リスト取得 |
| `getCompanyInfoFromList(rowIndex)` | 企業情報一覧から指定行取得 |
| `updateCompanyInfoInList(rowIndex, data)` | 企業情報一覧の指定行を更新 |
| `addCompanyInfoToList(data)` | 企業情報一覧に新規行追加 |

**削除した関数:**
- `getCompanyInfoFromSheet(sheetName)`
- `updateCompanyInfo(sheetName, data)`
- `saveCompanyInfo(targetSheet, data)`

### ✅ 完了: GASファイル間の関数重複問題を解決

**問題:** GASエディタ側の `contactFormats.js` に古い `showCompanyInfoParseDialog` が残っており、`companyInfoManager.js` と競合

**解決:** `contactFormats.js` をローカル版で上書き
- 連絡フォーマット機能のみを含む（企業情報入力関連は含まない）

---

### ✅ 完了: companyInfoManager.js 新規作成

キックオフ・企業情報入力関連の機能を集約した新ファイル。

**移行した機能:**
- 企業情報入力（Works貼り付け）: contactFormats.jsから移行
- 受注・キックオフ連絡: contactFormats.jsから移行
- 先方へ日程調整・フォーム記入依頼メール: contactFormats.jsから参照
- 企業情報編集: settingsSheet.jsから移行
- 企業情報一覧反映: 新規追加

### ✅ 完了: settingsSheet.js にシート作成機能追加

- プロンプトシート作成: `initializePromptSheet()`
- 企業情報一覧シート作成: `initializeCompanyListSheet()`

### ✅ 完了: 各GASファイルのメニュー変更

| ファイル | 変更内容 |
|----------|----------|
| companyInfoManager.js | 新規作成、`addKickoffMenu()` |
| hearingSheetManager.js | onOpen統合、ヒアリング+撮影フォルダ統合 |
| contactFormats.js | 日程調整メール削除、ナンバリング削除 |
| promptDialog.js | 4番に変更、文字起こし機能統合 |
| compositionDraftGenerator.js | 「生成」→「作成」に変更 |

---

### 前回: 連絡フォーマットGASエラー解決

**症状:**
- `TypeError: companySheets is not iterable` エラー

**解決策:**
- `contactFormats.js` の関数名を `getCompanySheetListForContacts` に変更（競合回避）

---

## 前回セッションの進捗（2026-01-10 続き）

### ✅ 完了: 企業情報入力パース機能

**実装内容:**
1. `contactFormats.js`: 「📥 企業情報入力（Works貼り付け）」メニュー追加
2. Worksから送られてくるフォーマットをパースして各フィールドに自動入力
3. 新規シート作成または既存シートへの保存が可能

**パース対応フィールド:**
- 基本情報: 企業名、担当者名、役職・部署、電話、メール、契約開始日
- 受注内容: 受注商材、契約期間、契約金額、備考
- 制作担当: メイン担当、サブ担当（設定シートから選択）

---

### ✅ 完了: 日程調整・フォーム記入メールダイアログ

**実装内容:**
1. `contactFormats.js`: 「📅 日程調整・フォーム記入メール」メニュー追加
2. 初回打ち合わせの日程調整メールを生成
3. 候補日程を動的に追加/削除可能
4. 参加者をチェックボックスで選択
5. GoogleフォームURLは設定シートから自動取得

---

### ✅ 完了: 企業情報修正ダイアログ

**実装内容:**
1. `settingsSheet.js`: 「🏢 企業情報修正」メニュー追加
2. 既存企業シートの基本情報をダイアログで編集可能
3. 担当者はドロップダウンで選択

**新メニュー構造（設定メニュー）:**
```
０.⚙️ 設定
├── 📋 設定シートを作成
├── 👥 メンバー編集
├── 📝 業務担当者編集
├── 📁 フォルダ設定編集
├── 📄 プロンプト編集
└── 🏢 企業情報修正 ★新規
```

---

### ✅ 完了: 受注後投稿フォーマット改善（tsunageru.ts）

**変更内容:**
1. 宛先とCCを別フィールドに分離
2. カレンダー確認メッセージを追加

**新テンプレート:**
```
{{mention}} cc:{{cc}}
新規受注です。
{{company}}様、ツナゲル12ヶ月契約。

初回打ち合わせはカレンダーを見て調整しますので、
予定の記入漏れがある方は記入してください。

詳細は上記フォーマットをご確認ください。
```

---

## 前回セッションの進捗（2026-01-10）

### ✅ 完了: 入力データの永続化

**実装内容:**
1. `hearingSheetManager.js`: Part③セクション（処理データ）をテンプレートに追加
2. `settingsSheet.js`: PART3_MAPPING、`savePart3Data()`、`loadPart3Data()` 関数を追加
3. `transcriptToHearingSheet.js`: 文字起こし原文の保存・読み込み機能を実装
4. `compositionDraftGenerator.js`: 構成案の保存・読み込み機能を実装

**Part③セクション構造:**
```
Part③ 処理データ（システム管理）
├─ 行135: 撮影素材フォルダURL
├─ 行136: メインフォルダURL
├─ 行137-141: 文字起こし原文（5行分）
├─ 行142-149: 構成案（原稿用）（8行分）
└─ 行150-157: 構成案（動画用）（8行分）
```

**UI改善:**
- シート選択時に「保存済み」バッジ表示
- 自動読み込み（ダイアログ開いたときに前回の入力を復元）
- 「💾 シートに保存」ボタン追加
- 上書き確認ダイアログ

---

### ✅ 完了: 撮影フォルダ作成の改善

**実装内容:**
1. `createShootingFolder.js`: 「📂 企業シートから作成」メニュー追加
2. 企業シート選択ダイアログ: 企業名を手入力せず、シート選択だけでフォルダ作成
3. フォルダURL自動保存: 作成したフォルダURLを企業シートPart③に自動保存
4. 「作成済み」バッジ: 既にフォルダがある企業シートには警告表示

**新メニュー構造:**
```
２.📁 撮影フォルダ
├── 🆕 新規フォルダ作成（従来の手入力方式）
├── 📂 企業シートから作成 ★新規
├── 📋 最近作成したフォルダ一覧
└── ⚙️ 親フォルダを設定
```

---

### 完了: 設定シートGAS完成（settingsSheet.js）

**メニュー構造:**
```
０.⚙️ 設定
├── 📋 設定シートを作成
├── 👥 メンバー編集
├── 📝 業務担当者編集（複数人対応・チェックボックス方式）
├── 📁 フォルダ設定編集（サブフォルダ追加・削除可能）
└── 📄 プロンプト編集（一覧・追加・編集・削除）
```

**設定シート構造:**
```
A列〜B列: メンバー一覧（名前、備考）
D列〜F列: 業務担当者（No、業務名、担当者 ※複数可・カンマ区切り）
H列〜I列: フォルダ設定（親フォルダID案内、サブフォルダ1〜）
```

**フォルダ管理の分離:**
- 親フォルダID: PropertiesService（「📁撮影フォルダ」→「親フォルダを設定」から変更）
- サブフォルダ: 設定シートH列（ダイアログで追加・削除可能）

**getValue系関数（他GASから呼び出し）:**
- `getMemberList()` → メンバー一覧
- `getAssigneeByTaskNo(no)` → 業務Noから担当者取得
- `getSubfoldersFromSettings()` → サブフォルダ一覧
- `getSettingsFromSheet()` → 後方互換（役割ベース）

---

## 将来タスク（UI確定後）

### GAS UIコンポーネントの共通化

全ダイアログのUIが確定したら、HTMLファイルとして分離・共通化する。

**構成:**
```
GASエディタ
├── dialogStyles.html    # 共通CSS（CI_DIALOG_STYLES等）
└── uiComponents.html    # 共通JavaScript（ドロップダウン、アコーディオン等）
```

**共通化対象:**
- コンパクトドロップダウン（担当者選択）
- プレーンテンプレートアコーディオン
- 結果表示エリア + コピー機能
- 共通スタイル（ボタン、フォーム、ステータス表示）

**参照:** ガイドラインV2 セクション3

---

## 次回セッションでやること（重要・必読）

### ✅ 完了: settingsSheet.js の同期と連携

**設定シートの設計意図:**

| 列 | 用途 | 重要度 |
|----|------|--------|
| **A列（メンバー一覧）** | 各ダイアログで担当者を選ぶ**ドロップダウンの選択肢** | **メイン** |
| D〜F列（業務担当者） | デフォルト値を決めるだけ | サブ |
| H列（フォルダ設定） | サブフォルダ名など | サブ |

**完了済み（2026-01-10）:**
1. ✅ settingsSheet.js をGASエディタに追加済み
2. ✅ createShootingFolder.js がサブフォルダを `getSubfoldersFromSettings()` から取得するよう修正
3. ✅ 撮影担当者テンプレートが設定シートの担当者を使用するよう修正

---

### ✅ 完了: 担当者プレースホルダーの実装

**settingsSheet.js で定義済みの機能:**
```javascript
// 設定シートから担当者情報を取得
getSettingsFromSheet()  // → { '原稿担当1': '河合', '動画担当': '川崎', ... }

// プレースホルダーを置換
replacePlaceholders(text, settings)
// {{原稿担当1}} → 河合
// {{@原稿担当1}} → @河合
// {{原稿チーム}} → 河合・中尾文香
// {{@原稿チーム}} → @河合 @中尾文香
```

**完了済み（2026-01-10）:**
1. ✅ compositionDraftGenerator.js: 変換ダイアログで `replacePlaceholders()` 呼び出し済み（776行）
2. ✅ transcriptToHearingSheet.js: プロンプト生成時に `replacePlaceholders()` 呼び出し追加（133-137行）
3. ✅ createShootingFolder.js: 撮影担当者テンプレートで `getSettingsFromSheet()` から担当者取得（176-177行、497-499行）

**プロンプトシートのテンプレートにプレースホルダーを記載可能:**
- 例: `CC: {{@CC}}`、`原稿担当: {{@原稿チーム}}`

---

### ✅ 完了: 入力データの永続化

**実装済み:** 本セッションの進捗を参照

---

### ✅ 完了: 撮影フォルダ作成の改善

**実装済み:** 本セッションの進捗を参照

**今後の拡張（オプション）:**
- ヒアリングシート作成時に自動でフォルダも作成する機能
- フォルダURLプレースホルダー（`{{撮影素材フォルダURL}}`）のテンプレート対応

---

## 参照

**ファイル内容レポート:** `docs/reports/file-contents-report-2026-01-10.md`

tsunageru.tsとGASファイル全8つの内容を記載。

---

## 関連リンク

- **制作陣業務一覧**: 元データのスプレッドシート
- **ヒアリングシート（テンプレート）**: GAS動作確認用

---

## 担当者一覧（ツナゲル）

| 担当者 | 色 | 主な業務 |
|--------|-----|---------|
| 渡邉 | グレー | 受注・立ち上げ、日程調整 |
| 河合 | ピンク | 打ち合わせ、原稿、編集 |
| 中尾文香 | 黄色 | 原稿執筆 |
| 川崎 | 水色 | 企画、撮影、FB |
| 下脇田 | 紫 | FB |
| 紺谷 | オレンジ | 応募対応 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-12 | ✅ hearingSheetManager.js: フォーム回答選択UIをドロップダウン形式に変更（アクティブバッジ対応） |
| 2026-01-12 | ✅ 共通スタイル適用完了: 全7ファイルに`${CI_DIALOG_STYLES}`を適用 |
| 2026-01-12 | ✅ 企業選択時の担当者自動入力修正: contactName取得+制作担当ヒント削除 |
| 2026-01-12 | ✅ getCompanyListFromSheet修正: A列固定→「企業名」列を動的検索 |
| 2026-01-12 | ✅ GASメニュー表示問題完全解決: シート分析.gs削除（CI_DIALOG_STYLES重複が真の原因） |
| 2026-01-12 | ✅ GASコード修正: 定数統一+重複関数削除+getCompanyInfoFromSheet実装 |
| 2026-01-12 | ✅ GASメニュー問題の原因特定: ①`COMPANY_LIST_SHEET_NAME_EDIT`未定義 ②`getFormUrlFromSettings()`重複 |
| 2026-01-12 | 🚨 GASメニュー表示問題発生: 関数/定数競合の可能性 |
| 2026-01-12 | showScheduleEmailDialog() 実装完了（未確認）、contactFormats.js の旧関数コメントアウト |
| 2026-01-11 | ✅ 企業情報入力バグ修正: ■列スキップ対応、placeholderテキスト変更、内部メッセージ削除 |
| 2026-01-11 | ✅ 共通スタイル分離完了: commonStyles.js新規作成、companyInfoManager.jsから定義を移動 |
| 2026-01-11 | ✅ uiComponents.html問題解決: HTMLファイル分離→JS定数埋め込み方式に変更 |
| 2026-01-11 | 共通スタイルHTML作成（dialogStyles.html, uiComponents.html）、companyInfoManager.jsをHTML読み込み形式に修正 |
| 2026-01-11 | 設定シートに企業情報項目セクション追加（K列）、企業情報一覧を動的作成 |
| 2026-01-11 | 企業情報入力ダイアログにテンプレート表示機能追加（動的生成、■セクション対応） |
| 2026-01-11 | 文言修正: Works→ワークス、パース→展開 |
| 2026-01-11 | 受注・キックオフ連絡ダイアログUI修正完了、確定UI一覧追加 |
| 2026-01-11 | 企業情報機能を企業情報一覧シート中心に修正（編集・入力両方） |
| 2026-01-11 | GASファイル間の関数重複問題を解決 |
| 2026-01-11 | GASメニュー構成大幅変更、companyInfoManager.js新規作成 |
| 2026-01-11 | contactFormats.js GASエラー解決（関数名競合問題） |
| 2026-01-10 | ファイル内容レポート作成、HANDOFF整理 |
| 2026-01-10 | contactFormats.js作成 |
| 2026-01-10 | settingsSheet.js作成 |
| 2026-01-10 | createShootingFolder.js修正 |
| 2026-01-10 | transcriptToHearingSheet.js修正 |
| 2026-01-10 | compositionDraftGenerator.js修正 |
| 2026-01-09 | compositionDraftGenerator.js作成 |
| 2026-01-08 | tsunageru.ts flowSteps追加 |
| 2026-01-07 | 初期構築 |
