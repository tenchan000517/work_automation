# 業務効率化・マニュアル作成プロジェクト HANDOFF

## プロジェクト概要

制作陣の業務効率化とマニュアル整備プロジェクト。
9商材・52業務を対象に、AI活用による効率化とマニュアル改善を推進。

**ガイドライン**: `docs/manual-creation-guideline.md` を参照

---

## 設計思想

### スプレッドシート中心の設計
本体はスプレッドシート+GAS。Next.jsサイトは補助（閲覧用ビュー）。

**理由**: 担当者が直接メンテナンスできる。コード変更不要。

### GASの2つの機能
- **AIプロンプト生成**: データ+プロンプト → AIに貼り付け → AI出力を使う
- **フォーマット生成**: データ+テンプレート → そのまま使える定型文

### 基本セット構成
- プロンプトシート（AIプロンプト管理）
- 設定シート（担当者名等の設定値）
- フォーム連携時: 回答シート + 原本シート

**理由**: この構成なら新商材追加時も同じパターンで対応可能。

### GASダイアログとNext.js popupのUI統一
GASダイアログとNext.jsのオレンジボタン（popup）は同じ機能・同じUIにする。

**理由**:
- 開発時に片方を見れば両方わかる
- 設計が統一され、保守が楽
- ユーザー体験が一貫する

**UI仕様**: ガイドラインの「ダイアログUI仕様」を参照

### 入力データの永続化
ダイアログで入力したデータは一時的ではなく、スプレッドシートに保存して再利用する。

**フロー:**
1. 貼り付け → 対象シートのセルに保存
2. 次回開く → セルから読み込み → フィールドに自動入力
3. 後続フローでも同じデータを参照可能

**上書き時の挙動:**
- 既にデータがある状態で新規入力 → 「上書きしますか？」アラート
- OK → 上書き保存

**除外シート（対象シート選択肢に出さない）:**
- プロンプト
- 設定
- フォームの回答1
- ヒアリングシート（原本/テンプレート）

これらはシステムシートなので、企業データ保存先として選択不可。

---

## 商材別業務一覧

| 商材 | 業務数 | 進捗 |
|------|--------|------|
| ツナゲル | 14 | 配列順0〜5を新形式に移行済み |
| バツグン | 5 | 基本情報のみ |
| HP制作 | 8 | 基本情報のみ |
| LP制作 | 5 | 基本情報のみ |
| SNS広告 | 5 | 基本情報のみ |
| PV制作 | 5 | 基本情報のみ |
| パンフ | 3 | 基本情報のみ |
| ロゴ | 3 | 基本情報のみ |
| 月刊Sing | 4 | 基本情報のみ |
| **合計** | **52** | - |

---

## 完了済み機能

### システム基盤
- Next.js 16 + TypeScript + Tailwind CSS v4
- 商材別データ分割管理（`src/lib/data/*.ts`）
- 担当者別色分け表示
- 複数入力フィールド対応（InputFieldConfig）

### ツナゲル業務フロー
- 配列順0〜5: flowSteps + 複数入力フィールド対応
- GAS連携: ヒアリングシート管理、構成案生成、撮影フォルダ作成

### GASスクリプト
- `settingsSheet.js`: 設定シート管理（単独ファイル）★新規
- `hearingSheetManager.js`: ヒアリングシート統合管理（onOpen含む）
- `transcriptToHearingSheet.js`: 文字起こし転記
- `compositionDraftGenerator.js`: 構成案生成
- `createShootingFolder.js`: 撮影フォルダ作成
- `promptDialog.js`: プロンプトダイアログ

---

## ファイル構成

```
C:\work-manual\
├── HANDOFF.md                      # このファイル
├── docs/
│   ├── manual-creation-guideline.md  # マニュアル作成ガイドライン ★重要
│   ├── gas/                        # GASスクリプト（商材別フォルダ）
│   │   ├── tsunageru/              # ツナゲル専用
│   │   │   ├── settingsSheet.js         # 設定シート管理 ★単独
│   │   │   ├── hearingSheetManager.js   # メイン（onOpen含む）
│   │   │   ├── createShootingFolder.js  # 撮影フォルダ作成
│   │   │   ├── promptDialog.js          # プロンプトダイアログ
│   │   │   ├── transcriptToHearingSheet.js  # 文字起こし転記
│   │   │   ├── compositionDraftGenerator.js # 構成案生成
│   │   │   ├── sheetStructureChecker.js # メンテナンス用
│   │   │   └── _archive/           # 旧バージョン・未使用ファイル
│   │   └── (他商材)/               # 追加時にフォルダ作成
│   ├── prompts/                    # AIプロンプト
│   └── 業務一覧/                   # 商材別業務詳細（txt）
│
├── src/
│   ├── app/                        # Next.js Pages
│   ├── components/
│   │   ├── ContentModal.tsx        # ポップアップモーダル
│   │   └── TaskCard.tsx            # 業務カード
│   └── lib/
│       ├── data.ts                 # 再エクスポート
│       └── data/                   # 商材別データ
│           ├── index.ts            # 型定義
│           ├── tsunageru.ts        # ツナゲル（モデル）
│           └── ...                 # 他8商材
│
└── public/images/                  # スクリーンショット
```

---

## 開発コマンド

```bash
npx tsc --noEmit    # TypeScriptエラーチェック（コード変更後は必ず実行）
```

---

## 新形式とは

ツナゲルで確立した業務カードの形式。詳細は `docs/manual-creation-guideline.md` 参照。

**要点:**
- `flowSteps`: 業務の手順を横並びボックスで表示
- `inputFields`: 複数入力フィールド（企業名、日時、宛先等を個別入力）
- 画像は必ずキャプション付き（`{ url, caption }`形式）
- 担当者名はハードコードせず、`defaultValue`で設定

---

## 本セッションの進捗（2026-01-10）

### 完了: 設定シートGAS完成（settingsSheet.js）

**メニュー構造:**
```
０.⚙️ 設定
├── 📋 設定シートを作成
├── 👥 メンバー編集
├── 📝 業務担当者編集（複数人対応・チェックボックス方式）
├── 📁 フォルダ設定編集（サブフォルダ追加・削除可能）
└── 📄 プロンプト編集（一覧・追加・編集・削除）
```

**設定シート構造:**
```
A列〜B列: メンバー一覧（名前、備考）
D列〜F列: 業務担当者（No、業務名、担当者 ※複数可・カンマ区切り）
H列〜I列: フォルダ設定（親フォルダID案内、サブフォルダ1〜）
```

**フォルダ管理の分離:**
- 親フォルダID: PropertiesService（「📁撮影フォルダ」→「親フォルダを設定」から変更）
- サブフォルダ: 設定シートH列（ダイアログで追加・削除可能）

**getValue系関数（他GASから呼び出し）:**
- `getMemberList()` → メンバー一覧
- `getAssigneeByTaskNo(no)` → 業務Noから担当者取得
- `getSubfoldersFromSettings()` → サブフォルダ一覧
- `getSettingsFromSheet()` → 後方互換（役割ベース）

---

## 次回セッションでやること（重要・必読）

### ✅ 完了: settingsSheet.js の同期と連携

**設定シートの設計意図:**

| 列 | 用途 | 重要度 |
|----|------|--------|
| **A列（メンバー一覧）** | 各ダイアログで担当者を選ぶ**ドロップダウンの選択肢** | **メイン** |
| D〜F列（業務担当者） | デフォルト値を決めるだけ | サブ |
| H列（フォルダ設定） | サブフォルダ名など | サブ |

**完了済み（2026-01-10）:**
1. ✅ settingsSheet.js をGASエディタに追加済み
2. ✅ createShootingFolder.js がサブフォルダを `getSubfoldersFromSettings()` から取得するよう修正
3. ✅ 撮影担当者テンプレートが設定シートの担当者を使用するよう修正

---

### ✅ 完了: 担当者プレースホルダーの実装

**settingsSheet.js で定義済みの機能:**
```javascript
// 設定シートから担当者情報を取得
getSettingsFromSheet()  // → { '原稿担当1': '河合', '動画担当': '川崎', ... }

// プレースホルダーを置換
replacePlaceholders(text, settings)
// {{原稿担当1}} → 河合
// {{@原稿担当1}} → @河合
// {{原稿チーム}} → 河合・中尾文香
// {{@原稿チーム}} → @河合 @中尾文香
```

**完了済み（2026-01-10）:**
1. ✅ compositionDraftGenerator.js: 変換ダイアログで `replacePlaceholders()` 呼び出し済み（776行）
2. ✅ transcriptToHearingSheet.js: プロンプト生成時に `replacePlaceholders()` 呼び出し追加（133-137行）
3. ✅ createShootingFolder.js: 撮影担当者テンプレートで `getSettingsFromSheet()` から担当者取得（176-177行、497-499行）

**プロンプトシートのテンプレートにプレースホルダーを記載可能:**
- 例: `CC: {{@CC}}`、`原稿担当: {{@原稿チーム}}`

---

### ★★★ 最重要: 入力データの永続化 ★★★

**ユーザーの意図:**
ダイアログで入力・貼り付けしたデータは一時的ではなく、スプレッドシートのセルに保存する。
次回ダイアログを開いたときに、保存したデータが自動で入力欄に表示される。

**対象ダイアログ:**
- 文字起こし整理ダイアログ（transcriptToHearingSheet.js）
- 構成案生成ダイアログ（compositionDraftGenerator.js）
- その他、入力フィールドを持つ全ダイアログ

**実装フロー:**
1. ユーザーが入力欄に貼り付け
2. 「生成」or「コピー」ボタン押下時 → 対象シートのセルに保存
3. 次回ダイアログを開く → セルから読み込み → 入力欄に自動入力

**上書き確認アラート:**
- 既にデータがある状態で新規入力 → 「上書きしますか？」アラート
- OK → 上書き保存
- キャンセル → 何もしない

**保存先セルの設計:**
- 各ダイアログごとに、対象シートの特定セル（例: 専用の行・列）に保存
- または設定シートに「入力履歴」セクションを追加

---

### ★★★ 最重要: 撮影フォルダ作成の改善 ★★★

**現状の問題:**
- ヒアリングシート（企業シート）作成 → 撮影フォルダ作成 という順番
- フォルダ作成時に企業名を**手入力**している
- 既に企業シートがあるのに同じ名前を再入力 = **不一致リスク & 二度手間**

**改善案1: 企業シート選択からフォルダ作成**
```
フォルダ作成ダイアログ
├─ 企業シート選択: [株式会社テスト ▼]  ← 既存シートから選択
├─ または「新規入力」を選択 → 従来の手入力モード
└─ 「作成」ボタン → シート名から企業名を取得してフォルダ作成
```

**改善案2: ヒアリングシート作成時に自動でフォルダも作成（推奨）**
```
hearingSheetManager.js の新規作成時
├─ 企業名入力
├─ シート作成
└─ 同時にフォルダも作成
    └─ 履歴にも自動追加
```

**要件:**
- 履歴機能は残す（後からURLにアクセスしやすくするため）
- 企業シートとフォルダ名の一致を保証
- **フォルダURLを企業シートに保存** → 後続テンプレートで参照可能に

**後続テンプレートでの活用:**
```
企業シートに保存するデータ:
├─ 撮影素材フォルダURL
├─ メインフォルダURL
├─ 撮影候補日（5候補）
├─ 撮影確定日
└─ 住所（ヒアリングシートから転記）

↓ これらを各テンプレートで参照

撮影可能日確認連絡:
  @{{撮影担当}}
  {{企業名}}様の撮影日程について
  📁 撮影素材アップロード先: {{撮影素材フォルダURL}}
  【候補日】{{候補日1〜5}}

撮影指示連絡:
  @{{撮影担当}}
  {{企業名}}様 撮影日確定
  📁 撮影素材アップロード先: {{撮影素材フォルダURL}}
  【撮影日】{{確定日}}
  【住所】{{住所}}
```

**企業シートへの保存セル設計（Part③ 処理データ）:**
```
現状: Part② スカウト_備考 が行132で終了

追加: Part③ 処理データ（行140〜）
├─ 行140: [ヘッダー] Part③ 処理データ
├─ 行141: 撮影素材フォルダURL
├─ 行142: メインフォルダURL
├─ 行143: 文字起こし原文
├─ 行144: 構成案（原稿用）
├─ 行145: 構成案（動画用）
```
※ PropertiesServiceの履歴は容量制限あり → シートに永続保存が確実
※ 一時的なデータ（撮影候補日など）は保存不要

**修正対象箇所の特定:**

### GAS修正
| ファイル | 修正内容 | 優先度 |
|----------|----------|--------|
| `hearingSheetManager.js` | 新規作成時にフォルダも同時作成、Part③セクション追加 | 高 |
| `createShootingFolder.js` | 企業シートへURL保存する関数追加、企業シート選択ダイアログ追加 | 高 |
| `transcriptToHearingSheet.js` | Part③マッピング追加（行141〜145） | 中 |
| `compositionDraftGenerator.js` | 構成案を企業シートPart③に保存 | 中 |

### フロー修正（tsunageru.ts）
| 配列順 | 業務名 | 修正内容 |
|--------|--------|----------|
| No.2 | 打ち合わせ前準備 | 撮影可能日5候補確認 → 変更なし |
| No.4 | 打ち合わせ後対応 | 「撮影フォルダ作成」flowStep削除（シート作成時に自動化）、「撮影担当者へ連絡」でフォルダURLを自動取得に変更 |

### マニュアルシステム修正
| ファイル | 修正内容 |
|----------|----------|
| `docs/manual-creation-guideline.md` | Part③セクションの設計を追記 |
| `HANDOFF.md` | 完了済み |

### 具体的な修正ポイント（tsunageru.ts No.4）
```typescript
// 現在: No.4 flowSteps
{
  label: "撮影フォルダ作成",  // ← これが不要になる（シート作成時に自動化）
  ...
},
{
  label: "撮影担当者へ連絡",
  inputFields: [
    ...
    { id: "folderUrl", label: "撮影素材フォルダURL", placeholder: "https://..." }  // ← 手入力
  ]
}

// 改善後: folderUrlは企業シートから自動取得 or GASダイアログで自動入力
```

---

### ★★★ 最重要: ダイアログUIの統一 ★★★

**ユーザーの意図:**
GASダイアログとNext.jsのオレンジボタン（popup）は**同じ機能・同じUI**にする。

**理由:**
- 開発時に片方を見れば両方わかる
- 設計が統一され、保守が楽
- ユーザー体験が一貫する

**UI仕様:** ガイドライン `docs/manual-creation-guideline.md` の「ダイアログUI仕様」を参照

**やること:**
- 各GASダイアログのUIを統一
- Next.js ContentModal.tsx と一致させる

---

### 優先度中: ツナゲル配列順6〜13の新形式移行

配列順0〜5と同様に、残りの業務を新形式に移行:
- flowSteps追加
- 複数入力フィールド対応
- 画像はキャプション付き

---

### 優先度低: 他商材のブラッシュアップ

ツナゲル完了後、優先度順に他商材を整備:
1. バツグン（撮影・FBフローはツナゲルと共通部分多い）
2. HP制作
3. 以降は必要に応じて

---

### 保留中

| 項目 | 状況 |
|------|------|
| YouTubeアップロード手順 | flowStepsに追加予定 |

---

## 関連リンク

- **制作陣業務一覧**: 元データのスプレッドシート
- **ヒアリングシート（テンプレート）**: GAS動作確認用

---

## 担当者一覧（ツナゲル）

| 担当者 | 色 | 主な業務 |
|--------|-----|---------|
| 渡邉 | グレー | 受注・立ち上げ、日程調整 |
| 河合 | ピンク | 打ち合わせ、原稿、編集 |
| 中尾文香 | 黄色 | 原稿執筆 |
| 川崎 | 水色 | 企画、撮影、FB |
| 下脇田 | 紫 | FB |
| 紺谷 | オレンジ | 応募対応 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-10 | 撮影フォルダGAS改善: 担当者/CCドロップダウン、プレーンテンプレート、メニュー修正 |
| 2026-01-10 | GAS修正完了: サブフォルダ・撮影担当者・プレースホルダー連携を実装 |
| 2026-01-10 | HANDOFF修正: GAS同期未完了・サブフォルダ未連携・プレースホルダー未実装を警告追加 |
| 2026-01-10 | 設定シートGAS完成（プロンプト編集・複数担当者・フォルダ設定改善） |
| 2026-01-10 | 設定シートGAS作成（settingsSheet.js）業務Noベース設計 |
| 2026-01-10 | HANDOFF最適化（詳細履歴を削除、ガイドラインに移行） |
| 2026-01-10 | 複数入力フィールド対応完了 |
| 2026-01-10 | ツナゲル配列順0〜5の新形式統一 |
| 2026-01-10 | GAS同期: 古いファイルをアーカイブ移動、メニュー名更新 |
| 2026-01-09 | 構成案生成GAS作成 |
| 2026-01-08 | flowSteps改善、画像追加 |
| 2026-01-07 | 初期構築（Next.js、データ構造、GAS連携） |
